<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ä¾£ç©ºé—´</title> 
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; padding-top: 60px; }
        .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; }
        
        /* --- å¯¼èˆªæ  --- */
        nav { background: #333; padding: 0 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-left, .nav-right { display: flex; align-items: center; }
        nav a { color: white; text-decoration: none; padding: 20px 15px; height: 100%; }
        nav a:hover, nav a.active { background: #555; }
        .nav-right span { color: #ccc; margin-right: 15px; }
        .nav-right a.logout-btn { background-color: #c82333; }
        .nav-right a.logout-btn:hover { background-color: #DC3545; }
        
        /* --- è¡¨å•å’ŒæŒ‰é’® --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { background: #007BFF; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn-danger { background-color: #DC3545; }
        .btn-danger:hover { background-color: #c82333; }
        
        /* --- Flash æ¶ˆæ¯ --- */
        .flash-messages { padding-left: 0; }
        .flash { padding: 15px; margin-bottom: 15px; border-radius: 4px; list-style-type: none; }
        .flash.success { background: #d4edda; color: #155724; }
        .flash.error { background: #f8d7da; color: #721c24; }
        
        /* --- V2.5 é‚€è¯·ç æ ·å¼ --- */
        .invite-box { background: #f0f0f0; border: 1px dashed #ccc; padding: 15px; border-radius: 8px; text-align: center; }
        .invite-code { font-size: 2.5em; font-weight: bold; color: #333; letter-spacing: 3px; margin: 10px 0; }
        
        /* --- V3.0 æ—¥å†æ ·å¼ --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; border: 1px solid #ddd; padding: 5px; border-radius: 8px; }
        .calendar-header { font-weight: bold; text-align: center; padding: 8px 0; background: #f7f7f7; border-bottom: 1px solid #ddd; }
        .calendar-day { min-height: 100px; border: 1px solid #eee; padding: 8px; border-radius: 4px; background-color: #fafafa; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day:hover { background-color: #f0f0f0; }
        .calendar-day .day-number { font-size: 0.9em; font-weight: bold; }
        .calendar-day.other-month { background-color: #fff; color: #ccc; }
        .entry-dots { position: absolute; bottom: 8px; left: 8px; display: flex; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-me { background-color: #007BFF; }
        .dot-partner { background-color: #28a745; }
        
        /* --- V3.0 æ¨¡æ€æ¡† (Modal) æ ·å¼ --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; position: relative; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 15px; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        #journal-form textarea { width: 95%; height: 150px; }
        .journal-entry-view { margin-bottom: 15px; }
        .journal-entry-view strong { color: #007BFF; }
        .journal-entry-view.partner { border-top: 1px dashed #ccc; padding-top: 15px; }
        .journal-entry-view.partner strong { color: #28a745; }
        
        /* --- V3.1 çºªå¿µå†Œå¡ç‰‡æ ·å¼ --- */
        .memories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .memory-card { background: #fff; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; text-decoration: none; color: #333; }
        .memory-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .memory-card img { width: 100%; height: 180px; object-fit: cover; border-bottom: 1px solid #eee; }
        .memory-card-content { padding: 15px; }
        .memory-card-content h3 { margin: 0 0 8px 0; font-size: 1.2em; }
        .memory-card-meta { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .memory-card-author { font-size: 0.8em; color: #999; }
    </style>
</head>
<body>
    
    <!-- å¯¼èˆªæ  -->
    <nav>
        <div class="nav-left">
            {% if current_user.is_authenticated %}
                <!-- V3.0 (å…±äº«èœè°±) -->
                <a href="{{ url_for('index') }}" class="{{ 'active' if request.endpoint == 'index' else '' }}">å…±äº«èœè°±</a> 
                
                <!-- V3.1 (çºªå¿µå†Œ) -->
                <a href="{{ url_for('memories') }}" 
                   style="color: #f43f5e;" 
                   class="{{ 'active' if request.endpoint.startswith('memories') or request.endpoint.startswith('memory_') else '' }}">ğŸ’– çºªå¿µå†Œ</a>
                
                <!-- V1 (ä¿ç•™) -->
                <a href="{{ url_for('what_can_i_make') }}" class="{{ 'active' if request.endpoint == 'what_can_i_make' else '' }}">æˆ‘èƒ½åšä»€ä¹ˆ?</a>
                
                <!-- V2.5 (æƒ…ä¾£å…³è”) -->
                <a href="{{ url_for('partner_page') }}" 
                   style="color: #4CAF50;" 
                   class="{{ 'active' if request.endpoint.startswith('partner_') else '' }}">â¤ï¸ æˆ‘çš„ä¼´ä¾£</a>
                
                <!-- V3.0 (å…±äº«æ—¥è®°) -->
                <a href="{{ url_for('journal') }}" 
                   style="color: #ffc107;" 
                   class="{{ 'active' if request.endpoint.startswith('journal') else '' }}">ğŸ“… å…±äº«æ—¥è®°</a>
            {% else %}
                <a href="{{ url_for('login') }}">æƒ…ä¾£ç©ºé—´ (è¯·ç™»å½•)</a>
            {% endif %}
        </div>
        <div class="nav-right">
            {% if current_user.is_authenticated %}
                <span>æ‚¨å¥½, {{ current_user.username }}</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
            {% else %}
                <a href="{{ url_for('login') }}" class="{{ 'active' if request.endpoint == 'login' else '' }}">ç™»å½•</a>
                <a href="{{ url_for('register') }}" class="{{ 'active' if request.endpoint == 'register' else '' }}">æ³¨å†Œ</a>
            {% endif %}
        </div>
    </nav>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        
        <!-- Flash æ¶ˆæ¯ -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="flash {{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
        
        <!-- 
          å­æ¨¡æ¿ (index.html, login.html ç­‰) çš„å†…å®¹
          å°†åœ¨è¿™é‡Œè¢«æ’å…¥
        -->
        {% block content %}{% endblock %}
    </div>

    <!-- 
      V3.0/V3.2
      å…±äº«æ—¥è®°æ¨¡æ€æ¡† (Modal) 
      å®ƒæ”¾åœ¨ base.html ä¸­, è¿™æ · journal.html é¡µé¢å°±å¯ä»¥è°ƒç”¨å®ƒ
    -->
    <div id="journalModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 id="modal-title">...</h3>
            
            <!-- æŸ¥çœ‹è§†å›¾ -->
            <div id="journal-view">
                <!-- æˆ‘çš„æ—¥è®° -->
                <div id="view-me" class="journal-entry-view" style="display: none;">
                    <strong>{{ current_user.username if current_user.is_authenticated else 'æˆ‘' }} å†™é“:</strong>
                    <p id="view-me-content"></p>
                </div>
                <!-- ä¼´ä¾£çš„æ—¥è®° -->
                <div id="view-partner" class="journal-entry-view partner" style="display: none;">
                    <strong id="view-partner-name">... (TA) å†™é“:</strong>
                    <p id="view-partner-content"></p>
                </div>
                <button id="edit-my-entry-btn" class="btn" onclick="openEditView()">ç¼–è¾‘æˆ‘çš„æ—¥è®°</button>
            </div>
            
            <!-- ç¼–è¾‘/æ–°å»ºè§†å›¾ -->
            <div id="journal-edit" style="display: none;">
                <form id="journal-form" onsubmit="return saveJournal()">
                    <div class="form-group">
                        <label for="journal-content">æ‚¨åœ¨è¿™ä¸€å¤©çš„å¿ƒæƒ…/æ—¥è®°:</label>
                        <textarea id="journal-content" name="content" required></textarea>
                        <input type="hidden" id="journal-date" name="date">
                    </div>
                    <button type="submit" class="btn">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background-color: #aaa;">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 
      V3.0/V3.2
      æ¨¡æ€æ¡† (Modal) çš„ JavaScript
      (å·²ä¿®å¤ SyntaxError)
    -->
    <script>
        const modal = document.getElementById('journalModal');
        const modalTitle = document.getElementById('modal-title');
        const journalView = document.getElementById('journal-view');
        const journalEdit = document.getElementById('journal-edit');
        const viewMe = document.getElementById('view-me');
        const viewMeContent = document.getElementById('view-me-content');
        const viewPartner = document.getElementById('view-partner');
        const viewPartnerName = document.getElementById('view-partner-name');
        const viewPartnerContent = document.getElementById('view-partner-content');
        const editMyEntryBtn = document.getElementById('edit-my-entry-btn');
        const journalFormContent = document.getElementById('journal-content');
        const journalFormDate = document.getElementById('journal-date');
        let currentModalDate = null;
        
        // FIX (V4): openModal ç°åœ¨è¯»å– 'element' (this)
        // è¿™ä¸ªå‡½æ•°ä¼šä»è¢«ç‚¹å‡»çš„æ—¥å†æ ¼å­ (element) çš„ data-* å±æ€§ä¸­è¯»å–æ•°æ®
        function openModal(element) {
            // ä» <body> æ ‡ç­¾è·å–ä¼´ä¾£åå­— (ç”± journal.html è®¾ç½®)
            const partnerName = document.body.dataset.partnerName || 'TA';
            viewPartnerName.textContent = `${partnerName} (TA) å†™é“:`;
            
            // ä»è¢«ç‚¹å‡»çš„ <div> å…ƒç´ ä¸­è¯»å– data-* å±æ€§
            const data = element.dataset;
            const dateStr = data.date;
            const hasMe = (data.me === 'true');
            const hasPartner = (data.partner === 'true');
            const meContent = data.meContent || '';
            const partnerContent = data.partnerContent || '';

            currentModalDate = dateStr;
            journalFormDate.value = dateStr;
            modalTitle.textContent = `æ—¥è®°: ${dateStr}`;

            if (!hasMe && !hasPartner) {
                // 1. æ²¡æœ‰äººå†™è¿‡, æ‰“å¼€"ç¼–è¾‘"è§†å›¾
                journalFormContent.value = ''; 
                journalView.style.display = 'none';
                journalEdit.style.display = 'block';
            } else {
                // 2. è‡³å°‘æœ‰ä¸€äººå†™è¿‡, æ‰“å¼€"æŸ¥çœ‹"è§†å›¾
                journalView.style.display = 'block';
                journalEdit.style.display = 'none';
                
                if (hasMe) {
                    viewMe.style.display = 'block';
                    viewMeContent.textContent = meContent;
                    journalFormContent.value = meContent; // é¢„å¡«å……"ç¼–è¾‘"æ¡†
                    editMyEntryBtn.style.display = 'inline-block';
                    editMyEntryBtn.textContent = 'ç¼–è¾‘æˆ‘çš„æ—¥è®°';
                } else {
                    viewMe.style.display = 'none';
                    journalFormContent.value = ''; // "ç¼–è¾‘"æ¡†ä¸ºç©º
                    editMyEntryBtn.style.display = 'inline-block'; 
                    editMyEntryBtn.textContent = 'å†™æˆ‘çš„æ—¥è®°';
                }
                
                if (hasPartner) {
                    viewPartner.style.display = 'block';
                    viewPartnerContent.textContent = partnerContent;
                } else {
                    viewPartner.style.display = 'none';
                }
            }
            modal.style.display = 'block';
        }
        
        function openEditView() {
            modalTitle.textContent = `ç¼–è¾‘æ—¥è®°: ${currentModalDate}`;
            journalView.style.display = 'none';
            journalEdit.style.display = 'block';
        }
        function closeModal() {
            modal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // saveJournal å‡½æ•° (V3.0)
        // å®ƒä¼šå¼‚æ­¥åœ° (async) å°†æ—¥è®°æ•°æ® POST åˆ° /journal/add
        async function saveJournal() {
            const date = journalFormDate.value;
            const content = journalFormContent.value;
            try {
                // å‘é€ AJAX (Fetch) è¯·æ±‚åˆ° app.py
                const response = await fetch("{{ url_for('add_journal_entry') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        date: date,
                        content: content
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    closeModal();
                    // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°çš„æ—¥è®°åœ†ç‚¹
                    window.location.reload(); 
                } else {
                    alert('é”™è¯¯: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜æ—¥è®°æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚');
            }
            return false; // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤
        }
    </script>
</body>
</html>