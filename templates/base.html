<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情侣空间</title>

    <!-- --- V4.4 FIX: 补全 PWA 图标标签 (关键!) --- -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <!-- iOS 专用图标 (没有这一行，iPhone 上就没有图标) -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f43f5e">
    <!-- ------------------------------------------- -->
    
    <!-- V4.3: 使用国内 Staticfile CDN 加速 Tailwind -->
    <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- 加载 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ... (样式保持不变, 为了节省篇幅我省略了具体的 CSS 内容，请保留您原有的样式) ... */
        h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.67em; }
        h2 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.75em; }
        h3 { font-size: 1.17em; font-weight: bold; margin-bottom: 0.75em; }
        h4 { font-size: 1em; font-weight: bold; margin-bottom: 0.75em; }
        ul.list-disc { list-style-type: disc; margin-left: 1.5em; }
        ol.list-decimal { list-style-type: decimal; margin-left: 1.5em; }
        .text-rose-500 { color: #f43f5e !important; }
        .text-rose-600 { color: #e11d48 !important; }
        .text-rose-400 { color: #fb7185 !important; }
        .bg-rose-200 { background-color: #fecdd3 !important; }
        .bg-rose-500 { background-color: #f43f5e !important; }
        .hover\:bg-rose-600:hover { background-color: #e11d48 !important; }
        .hover\:text-rose-500:hover { color: #f43f5e !important; }
        .bg-rose-100 { background-color: #ffe4e6 !important; }
        .text-green-700 { color: #15803d !important; }
        .bg-green-100 { background-color: #dcfce7 !important; }
        .text-red-700 { color: #b91c1c !important; }
        .bg-red-100 { background-color: #fee2e2 !important; }
        body { font-family: 'Inter', sans-serif; background-color: #fffafb; padding-top: 70px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .btn { background-color: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: 500; transition: background-color 0.2s; }
        .btn:hover { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-delete-sm { background-color: #9ca3af; padding: 4px 8px; font-size: 0.875rem; }
        .btn-delete-sm:hover { background-color: #ef4444; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 5vh auto; padding: 24px; border: none; width: 90%; max-width: 500px; border-radius: 12px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-close { color: #9ca3af; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-close:hover { color: #1f2937; }
        .invite-box { background: #f9fafb; border: 2px dashed #d1d5db; padding: 20px; border-radius: 12px; text-align: center; }
        .invite-code { font-size: 2.5em; font-weight: 800; color: #1f2937; letter-spacing: 4px; margin: 15px 0; font-family: monospace; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; border: 1px solid #e5e7eb; padding: 8px; border-radius: 12px; background: white; }
        .calendar-header { font-weight: 600; text-align: center; padding: 8px 0; color: #6b7280; font-size: 0.9em; }
        .calendar-day { min-height: 80px; border: 1px solid #f3f4f6; padding: 6px; border-radius: 6px; background-color: #fff; position: relative; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background-color: #fff1f2; border-color: #fecdd3; }
        .calendar-day .day-number { font-size: 0.85em; font-weight: 600; color: #374151; }
        .calendar-day.other-month { background-color: #f9fafb; color: #d1d5db; pointer-events: none; }
        .entry-dots { position: absolute; bottom: 6px; left: 6px; display: flex; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-me { background-color: #3b82f6; }
        .dot-partner { background-color: #10b981; }
        .memories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .memory-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; transition: all 0.2s; text-decoration: none; color: inherit; display: block; }
        .memory-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .memory-card img { width: 100%; height: 200px; object-fit: cover; }
        .memory-card-content { padding: 16px; }
        .memory-card-content h3 { margin: 0 0 8px 0; font-size: 1.25em; font-weight: 700; color: #111827; }
        .memory-card-meta { font-size: 0.875em; color: #6b7280; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .memory-card-author { font-size: 0.8em; color: #9ca3af; text-align: right; }
        .wishlist-form { display: flex; gap: 10px; margin-bottom: 24px; }
        .wishlist-container { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 768px) { .wishlist-container { grid-template-columns: 1fr 1fr; } }
        .wishlist-column h3 { border-bottom: 2px solid #f3f4f6; padding-bottom: 12px; margin-bottom: 16px; color: #374151; }
        .wishlist-item { display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; }
        .wishlist-item:hover { border-color: #d1d5db; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .wishlist-item.completed { background-color: #f9fafb; }
        .wishlist-item.completed span { text-decoration: line-through; color: #9ca3af; }
        .wishlist-item-content { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
        .author-tag { font-size: 0.7em; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .author-me { background-color: #60a5fa; }
        .author-partner { background-color: #34d399; }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- 导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto max-w-5xl px-4 py-3">
            <div class="flex justify-between items-center mb-2">
                <a href="{{ url_for('index') }}" class="text-2xl font-bold text-rose-500 hover:text-rose-600 transition-colors no-underline">
                    我们的小窝 ❤️
                </a>
                <div class="flex items-center space-x-4">
                    {% if current_user.is_authenticated %}
                        <div class="hidden sm:flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full bg-rose-200 text-rose-600 flex items-center justify-center font-bold text-sm">
                                {{ current_user.username[0] | upper }}
                            </div>
                            {% if current_user.partner %}
                            <div class="w-8 h-8 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center font-bold text-sm">
                                {{ current_user.partner.username[0] | upper }}
                            </div>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('logout') }}" class="text-gray-500 hover:text-rose-500 transition-colors" title="退出登录">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </a>
                    {% else %}
                        <a href="{{ url_for('login') }}" class="text-sm font-medium text-gray-600 hover:text-rose-500 no-underline">登录</a>
                        <a href="{{ url_for('register') }}" class="text-sm font-medium text-white bg-rose-500 px-3 py-1.5 rounded-md hover:bg-rose-600 no-underline">注册</a>
                    {% endif %}
                </div>
            </div>
            
            {% if current_user.is_authenticated %}
            <!-- 导航链接 -->
            <nav class="overflow-x-auto">
                <ul class="flex space-x-1 min-w-max pb-1">
                    <li><a href="{{ url_for('index') }}" class="nav-link {{ 'active' if request.endpoint == 'index' else '' }}">
                        <i data-lucide="home" class="w-4 h-4 mr-1.5"></i>首页
                    </a></li>
                    
                    <li><a href="{{ url_for('memories') }}" class="nav-link {{ 'active' if request.endpoint.startswith('memory') else '' }}">
                        <i data-lucide="image" class="w-4 h-4 mr-1.5"></i>纪念册
                    </a></li>
                    
                    <li><a href="{{ url_for('journal') }}" class="nav-link {{ 'active' if request.endpoint.startswith('journal') else '' }}">
                        <i data-lucide="book-open" class="w-4 h-4 mr-1.5"></i>日记
                    </a></li>
                    
                    <li><a href="{{ url_for('wishlist') }}" class="nav-link {{ 'active' if request.endpoint.startswith('wishlist') else '' }}">
                        <i data-lucide="list" class="w-4 h-4 mr-1.5"></i>愿望
                    </a></li>
                    
                    <li><a href="{{ url_for('recipes_list') }}" class="nav-link {{ 'active' if request.endpoint.startswith('recipe') or request.endpoint == 'what_can_i_make' else '' }}">
                        <i data-lucide="coffee" class="w-4 h-4 mr-1.5"></i>菜谱
                    </a></li>
                    
                    <!-- NEW: 每日一问入口 -->
                    <li><a href="{{ url_for('daily_question') }}" class="nav-link {{ 'active' if request.endpoint.startswith('daily_question') else '' }}">
                        <i data-lucide="message-circle-question" class="w-4 h-4 mr-1.5"></i>每日一问
                    </a></li>
                    
                    <li><a href="{{ url_for('partner_page') }}" class="nav-link {{ 'active' if request.endpoint.startswith('partner') else '' }}">
                        <i data-lucide="heart" class="w-4 h-4 mr-1.5"></i>伴侣
                    </a></li>
                </ul>
            </nav>
            <style>
                .nav-link {
                    display: flex; align-items: center; padding: 8px 12px; font-weight: 600; color: #4b5563; 
                    border-radius: 8px; transition: all 0.2s; text-decoration: none; font-size: 0.95rem;
                }
                .nav-link:hover { color: #f43f5e; background-color: #fff1f2; }
                .nav-link.active { color: #f43f5e; background-color: #fff1f2; }
            </style>
            {% endif %}
        </div>
    </header>

    <main class="container mx-auto max-w-5xl p-4 mt-6">
        <!-- Flash 消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="space-y-3 mb-6">
            {% for category, message in messages %}
              {% set color_class = 'bg-green-100 text-green-700 border-green-200' if category == 'success' else 'bg-red-100 text-red-700 border-red-200' %}
              <div class="p-4 rounded-lg border {{ color_class }}">
                {{ message }}
              </div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- 
      共享日记模态框 (保留不变) 
    -->
    <div id="journalModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 id="modal-title" style="margin-top:0; margin-bottom:15px; font-size:1.25em; font-weight:bold;">...</h3>
            <div id="journal-view">
                <div id="view-me" class="journal-entry-view" style="display: none;">
                    <strong>{{ current_user.username if current_user.is_authenticated else '我' }} 写道:</strong>
                    <p id="view-me-content" style="margin-top:5px; white-space: pre-wrap;"></p>
                </div>
                <div id="view-partner" class="journal-entry-view partner" style="display: none;">
                    <strong id="view-partner-name">... (TA) 写道:</strong>
                    <p id="view-partner-content" style="margin-top:5px; white-space: pre-wrap;"></p>
                </div>
                <button id="edit-my-entry-btn" class="btn" style="margin-top:15px; width:100%;" onclick="openEditView()">编辑我的日记</button>
            </div>
            <div id="journal-edit" style="display: none;">
                <form id="journal-form" onsubmit="return saveJournal()">
                    <div class="form-group">
                        <label for="journal-content">您在这一天的心情/日记:</label>
                        <textarea id="journal-content" name="content" required></textarea>
                        <input type="hidden" id="journal-date" name="date">
                    </div>
                    <button type="submit" class="btn" style="width:100%;">保存</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background-color: #9ca3af; width:100%; margin-top:10px;">取消</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        // ... (日记 JS 逻辑保持不变) ...
        const modal = document.getElementById('journalModal');
        const modalTitle = document.getElementById('modal-title');
        const journalView = document.getElementById('journal-view');
        const journalEdit = document.getElementById('journal-edit');
        const viewMe = document.getElementById('view-me');
        const viewMeContent = document.getElementById('view-me-content');
        const viewPartner = document.getElementById('view-partner');
        const viewPartnerName = document.getElementById('view-partner-name');
        const viewPartnerContent = document.getElementById('view-partner-content');
        const editMyEntryBtn = document.getElementById('edit-my-entry-btn');
        const journalFormContent = document.getElementById('journal-content');
        const journalFormDate = document.getElementById('journal-date');
        let currentModalDate = null;
        
        function openModal(element) {
            const partnerName = document.body.dataset.partnerName || 'TA';
            viewPartnerName.textContent = `${partnerName} (TA) 写道:`;
            const data = element.dataset;
            const dateStr = data.date;
            const hasMe = (data.me === 'true');
            const hasPartner = (data.partner === 'true');
            const meContent = data.meContent || '';
            const partnerContent = data.partnerContent || '';
            currentModalDate = dateStr;
            journalFormDate.value = dateStr;
            modalTitle.textContent = `日记: ${dateStr}`;
            if (!hasMe && !hasPartner) {
                journalFormContent.value = ''; 
                journalView.style.display = 'none';
                journalEdit.style.display = 'block';
            } else {
                journalView.style.display = 'block';
                journalEdit.style.display = 'none';
                if (hasMe) {
                    viewMe.style.display = 'block';
                    viewMeContent.textContent = meContent;
                    journalFormContent.value = meContent; 
                    editMyEntryBtn.style.display = 'inline-block';
                    editMyEntryBtn.textContent = '编辑我的日记';
                } else {
                    viewMe.style.display = 'none';
                    journalFormContent.value = ''; 
                    editMyEntryBtn.style.display = 'inline-block'; 
                    editMyEntryBtn.textContent = '写我的日记';
                }
                if (hasPartner) {
                    viewPartner.style.display = 'block';
                    viewPartnerContent.textContent = partnerContent;
                } else {
                    viewPartner.style.display = 'none';
                }
            }
            if(modal) modal.style.display = 'block';
        }
        function openEditView() {
            modalTitle.textContent = `编辑日记: ${currentModalDate}`;
            journalView.style.display = 'none';
            journalEdit.style.display = 'block';
        }
        function closeModal() {
            if(modal) modal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == modal) { closeModal(); }
        }
       async function saveJournal() {
            const date = journalFormDate.value;
            const content = journalFormContent.value;
            
            // 1. 获取按钮对象
            const saveBtn = document.querySelector('#journal-form button[type="submit"]');
            const cancelBtn = document.querySelector('#journal-form button[type="button"]');
            const originalText = saveBtn.innerText;
            
            // 2. 立即禁用按钮，防止双击！(关键修复)
            saveBtn.disabled = true;
            cancelBtn.disabled = true;
            saveBtn.innerText = "保存中...";
            saveBtn.style.opacity = "0.7";

            try {
                const response = await fetch("{{ url_for('add_journal_entry') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        date: date,
                        content: content
                    })
                });

                // 尝试解析 JSON
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    // 如果不是 JSON，可能是 500/502 错误页
                    console.error("服务器返回非JSON:", text);
                    throw new Error(`服务器繁忙 (状态码: ${response.status})`);
                }

                if (response.ok) {
                    // 成功！
                    closeModal();
                    window.location.reload(); 
                } else {
                    // 失败
                    alert('保存失败: ' + result.message);
                }
            } catch (error) {
                console.error('保存失败:', error);
                // 3. 更友好的错误提示
                alert('网络连接不稳定，但数据可能已保存。\n请刷新页面查看。');
            } finally {
                // 4. 无论成功失败，恢复按钮状态
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
                saveBtn.innerText = originalText;
                saveBtn.style.opacity = "1";
            }
            return false; 
        }
    </script>
</body>
</html>