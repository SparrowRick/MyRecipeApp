{% extends "base.html" %}

{% block content %}
    <h2>ğŸ“… å…±äº«æ—¥è®° (2025å¹´ 10æœˆ - æ¨¡æ‹Ÿ)</h2>
    <p>
        <!-- 
          æ³¨æ„: "partner_name" æ˜¯ç”± app.py ä¸­çš„ journal() è·¯ç”±ä¼ é€’è¿‡æ¥çš„
          å¦‚æœæ‚¨çš„ä¼´ä¾£å°šæœªç»‘å®š, app.py ä¼šé‡å®šå‘åˆ°ä¼´ä¾£é¡µé¢, æ‰€ä»¥è¿™é‡Œ partner_name æ€»æ˜¯å­˜åœ¨çš„
        -->
        åœ¨è¿™é‡Œè®°å½•æ‚¨å’Œ <strong>{{ partner_name }}</strong> çš„å…±åŒå›å¿†ã€‚
        <span class="dot dot-me" style="display: inline-block;"></span> = {{ current_user.username }} (æˆ‘)
        <span class="dot dot-partner" style="display: inline-block; margin-left: 10px;"></span> = {{ partner_name }} (TA)
    </p>

    <!-- æ—¥å† -->
    <div class="calendar-grid">
        <!-- æ˜ŸæœŸ -->
        <div class="calendar-header">æ—¥</div>
        <div class="calendar-header">ä¸€</div>
        <div class="calendar-header">äºŒ</div>
        <div class="calendar-header">ä¸‰</div>
        <div class="calendar-header">å››</div>
        <div class="calendar-header">äº”</div>
        <div class="calendar-header">å…­</div>
        
        <!--
          è¿™æ˜¯ä¸€ä¸ªâ€œæ¨¡æ‹Ÿâ€çš„æ—¥å† (2025å¹´10æœˆ)ã€‚
          ä¸€ä¸ªâ€œçœŸæ­£â€çš„æ—¥å†éœ€è¦åç«¯ Python (ä½¿ç”¨ calendar åº“) æ¥åŠ¨æ€ç”Ÿæˆæ¯å¤©çš„æ—¥æœŸ,
          ä½†ä¸ºäº† V3.0 çš„é¦–æ¬¡å‘å¸ƒ, æˆ‘ä»¬å…ˆç”¨è¿™ä¸ªæ¨¡æ‹Ÿçš„ç½‘æ ¼æ¥å±•ç¤ºæ•°æ®ã€‚
        -->

        <!-- ç¬¬ 1 è¡Œ (æ¨¡æ‹Ÿ 2025-10-01 æ˜¯å‘¨ä¸‰) -->
        <div class="calendar-day other-month"><div class="day-number">28</div></div>
        <div class="calendar-day other-month"><div class="day-number">29</div></div>
        <div class="calendar-day other-month"><div class="day-number">30</div></div>
        
        {% set date_str = '2025-10-01' %}
        <!-- 
          1. ä» app.py ä¼ æ¥çš„ calendar_data ä¸­è·å–å½“å¤©çš„æ—¥è®°æ•°æ®
          2. .get(..., {...}) æ˜¯ä¸€ä¸ªå®‰å…¨çš„æ“ä½œ, å¦‚æœå½“å¤©æ²¡æœ‰æ—¥è®°, å®ƒä¼šè¿”å›ä¸€ä¸ªç©ºçš„é»˜è®¤å­—å…¸
          3. data | tojson ä¼šæŠŠ Python å­—å…¸å®‰å…¨åœ°è½¬æ¢ä¸º JavaScript å¯¹è±¡
        -->
        {% set data = calendar_data.get(date_str, {'me': False, 'partner': False, 'me_content': '', 'partner_content': ''}) %}
        <!-- FIX: Added |safe filter to prevent HTML-escaping of the JSON object. -->
        <div class="calendar-day" onclick='openModal("{{ date_str }}", {{ data | tojson | safe }})'>
            <div class="day-number">1</div>
            <div class="entry-dots">
                {% if data.me %}<span class="dot dot-me"></span>{% endif %}
                {% if data.partner %}<span class="dot dot-partner"></span>{% endif %}
            </div>
        </div>
        
        {% set date_str = '2025-10-02' %}
        {% set data = calendar_data.get(date_str, {'me': False, 'partner': False, 'me_content': '', 'partner_content': ''}) %}
        <!-- FIX: Added |safe filter. -->
        <div class="calendar-day" onclick='openModal("{{ date_str }}", {{ data | tojson | safe }})'>
            <div class="day-number">2</div>
            <div class="entry-dots">
                {% if data.me %}<span class="dot dot-me"></span>{% endif %}
                {% if data.partner %}<span class="dot dot-partner"></span>{% endif %}
            </div>
        </div>
        
        {% set date_str = '2025-10-03' %}
        {% set data = calendar_data.get(date_str, {'me': False, 'partner': False, 'me_content': '', 'partner_content': ''}) %}
        <!-- FIX: Added |safe filter. -->
        <div class="calendar-day" onclick='openModal("{{ date_str }}", {{ data | tojson | safe }})'>
            <div class="day-number">3</div>
            <div class="entry-dots">
                {% if data.me %}<span class="dot dot-me"></span>{% endif %}
                {% if data.partner %}<span class="dot dot-partner"></span>{% endif %}
            </div>
        </div>

        {% set date_str = '2025-10-04' %}
        {% set data = calendar_data.get(date_str, {'me': False, 'partner': False, 'me_content': '', 'partner_content': ''}) %}
        <!-- FIX: Added |safe filter. -->
        <div class="calendar-day" onclick='openModal("{{ date_str }}", {{ data | tojson | safe }})'>
            <div class="day-number">4</div>
            <div class="entry-dots">
                {% if data.me %}<span class="dot dot-me"></span>{% endif %}
                {% if data.partner %}<span class="dot dot-partner"></span>{% endif %}
            </div>
        </div>

        <!-- 
          ç¬¬ 2 è¡Œå¼€å§‹, æˆ‘ä»¬ç”¨ä¸€ä¸ª for å¾ªç¯æ¥ç”Ÿæˆ 5å· åˆ° 31å·
          (ä¸€ä¸ªçœŸæ­£çš„æ—¥å†ä¼šæ›´å¤æ‚, éœ€è¦è®¡ç®—æ¢è¡Œ)
        -->
        
        {% for day in range(5, 32) %}
            <!-- æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸², e.g., "2025-10-05" (05 ä¿è¯äº†ä¸¤ä½æ•°) -->
            {% set date_str = '2025-10-%02d' | format(day) %}
            {% set data = calendar_data.get(date_str, {'me': False, 'partner': False, 'me_content': '', 'partner_content': ''}) %}
            
            <!-- FIX: Added |safe filter. -->
            <div class="calendar-day" onclick='openModal("{{ date_str }}", {{ data | tojson | safe }})'>
                <div class="day-number">{{ day }}</div>
                <div class="entry-dots">
                    {% if data.me %}<span class="dot dot-me"></span>{% endif %}
                    {% if data.partner %}<span class="dot dot-partner"></span>{% endif %}
                </div>
            </div>
        {% endfor %}
        
        <!-- ä¸‹ä¸ªæœˆçš„ (æ¨¡æ‹Ÿ) -->
        <div class="calendar-day other-month"><div class="day-number">1</div></div>

    </div>

    <!-- 
      è¿™ä¸ªè„šæœ¬å—å¿…é¡»åœ¨ journal.html ä¸­,
      å› ä¸ºå®ƒéœ€è¦æŠŠ Python å˜é‡ (calendar_data å’Œ partner_name) ä¼ é€’ç»™ base.html ä¸­çš„å…¨å±€ JS
    -->
    <script>
        // 1. å¡«å…… JS å˜é‡ (æ¥è‡ª base.html)
        // (æˆ‘ä»¬æŠŠ Python å­—å…¸è½¬æ¢ä¸ºå®‰å…¨çš„ JSON å­—ç¬¦ä¸², ç„¶å JS å†è§£æå®ƒ)
        // This part needs |safe because it's in a <script> tag, not an HTML attribute.
        calendarData = {{ calendar_data | tojson | safe }};
        
        // 2. æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„ä¼´ä¾£åå­— (æ¥è‡ª base.html)
        document.getElementById('view-partner-name').textContent = "{{ partner_name }} (TA) å†™é“:";
    </script>

{% endblock %}