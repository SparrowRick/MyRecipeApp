{% extends "base.html" %}

{% block content %}
    
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold text-gray-800">ğŸ“… å…±äº«æ—¥è®°</h2>
        
        <!-- æœˆä»½åˆ‡æ¢å™¨ -->
        <div class="flex items-center bg-white rounded-lg shadow-sm border p-1">
            <!-- ä¸Šä¸ªæœˆ -->
            {% set prev_month = month - 1 if month > 1 else 12 %}
            {% set prev_year = year if month > 1 else year - 1 %}
            <a href="{{ url_for('journal', year=prev_year, month=prev_month) }}" class="p-2 hover:bg-gray-100 rounded-full text-gray-600">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
            </a>
            
            <span class="mx-4 font-bold text-lg w-32 text-center">{{ year }}å¹´ {{ month }}æœˆ</span>
            
            <!-- ä¸‹ä¸ªæœˆ -->
            {% set next_month = month + 1 if month < 12 else 1 %}
            {% set next_year = year if month < 12 else year + 1 %}
            <a href="{{ url_for('journal', year=next_year, month=next_month) }}" class="p-2 hover:bg-gray-100 rounded-full text-gray-600">
                <i data-lucide="chevron-right" class="w-5 h-5"></i>
            </a>
        </div>
    </div>

    <p class="mb-4 text-gray-600">
        {% if partner_name %}
            <span class="dot dot-me" style="display: inline-block;"></span> = æˆ‘
            <span class="dot dot-partner" style="display: inline-block; margin-left: 10px;"></span> = {{ partner_name }}
        {% endif %}
    </p>

    <!-- çœŸå®æ—¥å†ç½‘æ ¼ -->
    <div class="calendar-grid">
        <!-- æ˜ŸæœŸè¡¨å¤´ -->
        <div class="calendar-header">ä¸€</div>
        <div class="calendar-header">äºŒ</div>
        <div class="calendar-header">ä¸‰</div>
        <div class="calendar-header">å››</div>
        <div class="calendar-header">äº”</div>
        <div class="calendar-header text-rose-500">å…­</div>
        <div class="calendar-header text-rose-500">æ—¥</div>
        
        <!-- 
          éå†åç«¯ä¼ æ¥çš„æ—¥å†çŸ©é˜µ 
          week æ˜¯ä¸€ä¸ªåˆ—è¡¨, å¦‚ [0, 0, 1, 2, 3, 4, 5]
        -->
        {% for week in cal_matrix %}
            {% for day in week %}
                
                {% if day == 0 %}
                    <!-- 0 ä»£è¡¨ç©ºç™½(ä¸Šæœˆæˆ–ä¸‹æœˆ) -->
                    <div class="calendar-day other-month"></div>
                {% else %}
                    <!-- çœŸå®æ—¥æœŸ -->
                    <!-- æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD -->
                    {% set date_str = '%04d-%02d-%02d' | format(year, month, day) %}
                    {% set data = calendar_data.get(date_str, {'me': False, 'partner': False, 'me_content': '', 'partner_content': ''}) %}
                    
                    <div class="calendar-day" 
                         data-date="{{ date_str }}"
                         data-me="{{ 'true' if data.me else 'false' }}"
                         data-partner="{{ 'true' if data.partner else 'false' }}"
                         data-me-content="{{ data.me_content }}"
                         data-partner-content="{{ data.partner_content }}"
                         onclick="openModal(this)">
                        
                        <div class="day-number">{{ day }}</div>
                        <div class="entry-dots">
                            {% if data.me %}<span class="dot dot-me"></span>{% endif %}
                            {% if data.partner %}<span class="dot dot-partner"></span>{% endif %}
                        </div>
                    </div>
                {% endif %}
                
            {% endfor %}
        {% endfor %}
    </div>

    <script>
        document.body.dataset.partnerName = "{{ partner_name }}";
        // é‡æ–°æ¿€æ´»å›¾æ ‡
        if (typeof lucide !== 'undefined') lucide.createIcons();
    </script>
{% endblock %}
```

---

### ç¬¬äºŒæ­¥ï¼šè®©é¦–é¡µåŠ¨æ€å˜â€œæ´»â€

æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `app.py` çš„ `index` è·¯ç”±æ¥æŸ¥è¯¢çœŸå®æ•°æ®ï¼Œå¹¶ä¿®æ”¹ `index.html` æ¥æ˜¾ç¤ºå®ƒä»¬ã€‚

#### 1. ä¿®æ”¹ `app.py`
æ‰¾åˆ° `index()` è·¯ç”±ï¼Œ**æ›¿æ¢**ä¸ºä»¥ä¸‹ä»£ç ï¼š

```python
@app.route('/')
@login_required
def index():
    # 1. è·å– ID åˆ—è¡¨
    user_ids = [current_user.id]
    if current_user.partner_id:
        user_ids.append(current_user.partner_id)
    
    # 2. æŸ¥è¯¢æœ€è¿‘çš„åŠ¨æ€ (Activities)
    activities = []
    
    # æŸ¥è¯¢æœ€è¿‘çš„ 3 ä¸ªèœè°±
    recent_recipes = Recipe.query.filter(Recipe.user_id.in_(user_ids)).order_by(Recipe.id.desc()).limit(3).all()
    for r in recent_recipes:
        activities.append({
            'type': 'recipe',
            'time': r.id, # è¿™é‡Œå·æ‡’ç”¨IDæ’åº, ç†æƒ³æƒ…å†µåº”æ·»åŠ  created_at å­—æ®µ
            'text': f"{'æˆ‘' if r.author_id == current_user.id else 'TA'} æ·»åŠ äº†æ–°èœè°±: {r.name}"
        })
        
    # æŸ¥è¯¢æœ€è¿‘çš„ 3 ä¸ªå›å¿†
    recent_memories = Memory.query.filter(Memory.author_id.in_(user_ids)).order_by(Memory.id.desc()).limit(3).all()
    for m in recent_memories:
        activities.append({
            'type': 'memory',
            'time': m.id,
            'text': f"{'æˆ‘' if m.author_id == current_user.id else 'TA'} æ·»åŠ äº†æ–°å›å¿†: {m.title}"
        })
    
    # ç®€å•æ’åºå¹¶å–å‰ 5 ä¸ª (æ··åˆæ’åº)
    # æ³¨æ„: å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç»Ÿä¸€çš„æ—¶é—´å­—æ®µ, è¿™é‡Œåªæ˜¯ç®€å•çš„æ··æ’, 
    # çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒåº”è¯¥ç»™æ‰€æœ‰è¡¨åŠ  created_at å­—æ®µ
    activities.sort(key=lambda x: x['time'], reverse=True)
    latest_activities = activities[:5]

    return render_template('index.html', activities=latest_activities)
```

#### 2. ä¿®æ”¹ `templates/index.html`
ä¿®æ”¹â€œæœ€è¿‘åŠ¨æ€â€éƒ¨åˆ†ï¼Œä½¿ç”¨å¾ªç¯æ¥æ¸²æŸ“ã€‚

```html
    <!-- ... ä¸Šé¢çš„ä»£ç ä¸å˜ ... -->

    <!-- åŠ¨æ€éƒ¨åˆ† -->
    <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">æœ€è¿‘åŠ¨æ€</h2>
        <div class="bg-white rounded-xl shadow-lg p-6 space-y-4">
            
            {% for activity in activities %}
                <div class="border-l-4 
                    {{ 'border-rose-400' if activity.type == 'recipe' else 'border-blue-400' }} 
                    pl-4">
                    <p class="font-semibold">{{ activity.text }}</p>
                    <!-- ç”±äºæ²¡æœ‰çœŸå®æ—¶é—´å­—æ®µï¼Œæš‚æ—¶ä¸æ˜¾ç¤ºæ—¶é—´ï¼Œæˆ–è€…æ˜¾ç¤º 'è¿‘æœŸ' -->
                    <span class="text-sm text-gray-500">è¿‘æœŸ</span>
                </div>
            {% else %}
                <p class="text-gray-500">è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«å»æ·»åŠ ç¬¬ä¸€ä¸ªå†…å®¹å§ï¼</p>
            {% endfor %}
            
        </div>
    </div>

    <!-- ... ä¸‹é¢çš„ä»£ç ä¸å˜ ... -->